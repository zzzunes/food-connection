<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta charset="utf-8">
    <title>User Data</title>

</head>
<h1> Enter the New Food: </h1>
<body>
    Demography: <br><br>
        <div>
        <label> All Users<input type="checkbox" name="allUsers" id="nuts"></label><br><br>
        Race:

            <label>black<input type="checkbox" name="black" value= "" id="black"></label>
            <label>white<input type="checkbox" name="white" id="white"></label>
            <label>asian<input type="checkbox" name="asian" id="asian"></label>
            <label>hispanic<input type="checkbox" name="hispanic" id="hispanic"></label>
        <br><br>
        Age Range:

            <label>min<input type="number" name="min_age" id="min_age" value="0" min="1" max="100"></label>
            <label>max<input type="number" name="min_age" id="max_age" value="100" min="1" max="100"></label>
        <br><br>

        Gender:

            <label>male<input type="checkbox" name="male" id="male"></label>
            <label>female<input type="checkbox" name="female" id="female"></label>
            <label>non-binary<input type="checkbox" name="non_binary" id="non_binary"></label>
        <br><br>
    </div>
    <!-- FOR FUTURE IMPLEMENTATION
    <div>
        Date:
        <label> since: <input type="date" name="date_range_num" id="date_range_num" > </label>

    </div>>

    Major:
    <div>
        <label>Math<input type="checkbox" name="black" id="math"></label>
        <label>Engineering<input type="checkbox" name="black" id="engineering"></label>
        <label>Liberal Arts<input type="checkbox" name="black" id="liberal_arts"></label>
        <label>Health Science<input type="checkbox" name="black" id="health_science"></label>
    </div><br><br>
    FOR FUTURE IMPLEMENTATION-->
    <input type="submit" value="Average Nutrients per Meal" onclick="perMeal()">
    <input type="submit" value="Show Raw Data" >
</body>
<script type="text/javascript">


    /*Fetch data from DB
    * returns array of User objects
    * */
    async function getData(){
        var jsonData= await fetch('/users/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(res=>res.json())
            .then( json=> {return json;});
        console.log("Data fetched.");
        return jsonData;
    }//end getData()


    /*Displays data
    * prints: user data as: gender, age, race
    * */
    function display(data){

        for (let e=0;e<data.length; e++){
            console.log(data[e].gender,data[e].age,data[e].race);
        }
    }//end display()


    /*Collects user criterias from HTML input
    * returns: an Array of criterias
    * */
    async function selectedDemos(){
        var demos={};
        const male = document.getElementById("male");
        const female = document.getElementById("female");
        const non_binary = document.getElementById("non_binary");
        const black = document.getElementById("black");
        const white = document.getElementById("white");
        const asian = document.getElementById("asian");
        const hispanic = document.getElementById("hispanic");
        const min_age = document.getElementById("min_age");
        const max_age = document.getElementById("max_age");
        
        var genders=[];
        if (male.checked){
            genders.push("Male");
        }
        if (female.checked){
            genders.push("Female");
        }
        if (non_binary.checked) {
            genders.push("Non-Binary");
        }
        var key="genders";
        demos[key]=genders;

        var races=[];
        if (black.checked){
            races.push("Black");
        }
        if (white.checked){
            races.push("White");
        }
        if (asian.checked){
            races.push("Asian");
        }
        if (hispanic.checked){
            races.push("Hispanic");
        }
        key="races";
        demos[key] = races;

        var ageRange=[];
        ageRange[0]=min_age.value;
        if(ageRange[0]=="") ageRange[0]=min_age.defaultValue;
        ageRange[1]=max_age.value;
        if(ageRange[1]=="") ageRange[1]=max_age.defaultValue;
        //console.log(ageRange[0],ageRange[1]);
        key="ageRange";
        demos[key] = ageRange;

        return demos;
    }//end selectedDemos()


    /*filters data by demographic criteria
    * Arguments: array of demo criterias, array of users
    * returns: array of users that meet criterias.
    *  */
    function narrowData(demos,arrayData) {
        var filteredData=[];
        for(let e in arrayData) {
            //console.log(demos.genders[0]);
            if (demos.genders[0] != undefined) {
                var gender= arrayData[e].gender;
                if (demos.genders.find(function(element){return element == gender;})== undefined){
                    continue;

                }
            }
            //console.log(demos.races[0]);
            if (demos.races[0] != undefined ) {
                var race= arrayData[e].race;
                if (demos.races.find(function(element){return element == race;}) == undefined){
                    continue;
                }
            }
            if (demos.ageRange[0] != 0 || demos.ageRange[1] != 100) {
                var age= arrayData[e].age;
                if (age<demos.ageRange[0] || age> demos.ageRange[1]){
                    continue;
                }
            }
           filteredData.push(arrayData[e]);
        }
        return filteredData;
    }// end narrowData()

    function getStatsPerMeal(userArray,option=0){
        var microNutes=["calories","carbs","fat","protein"];
        var populationMicroNutesPm;
        var userCount=0;

        var userMicroNutesPMeal=[];
        for (let u in userArray){
            var userTotals=[0,0,0,0]; //[calories,carbs,fat,protein]
            let mealCount=0;
            if (typeof userArray[u].foodHistory[0]=="undefined") continue;
            else {
                for (let f in userArray[u].foodHistory) {
                    userTotals[0] += userArray[u].foodHistory[f].food.calories;
                    userTotals[1] += userArray[u].foodHistory[f].food.carbs;
                    userTotals[2] += userArray[u].foodHistory[f].food.fat;
                    userTotals[3] += userArray[u].foodHistory[f].food.protein;
                    mealCount++;
                }
                userMicroNutesPMeal.push({[microNutes[0]]:userTotals[0]/mealCount,[microNutes[1]]:userTotals[1]/mealCount,[microNutes[2]]:userTotals[2]/mealCount,[microNutes[3]]:userTotals[3]/mealCount});
                userCount++;
            }

        }
        var populationTots=[0,0,0,0];  //[calories,carbs,fat,protein]
        for (let e in userMicroNutesPMeal){
            populationTots[0] += userMicroNutesPMeal[e].calories;
            populationTots[1] += userMicroNutesPMeal[e].carbs;
            populationTots[2] += userMicroNutesPMeal[e].fat;
            populationTots[3] += userMicroNutesPMeal[e].protein;
        }
        populationMicroNutesPm={[microNutes[0]]:(populationTots[0]/userCount).toPrecision(3),[microNutes[1]]:(populationTots[1]/userCount).toPrecision(3),[microNutes[2]]:(populationTots[2]/userCount).toPrecision(3),[microNutes[3]]:(populationTots[3]/userCount).toPrecision(3)};
        if (option===0) return populationMicroNutesPm;
        else return userMicroNutesPMeal;
    }


    /* main method that runs onclick()*/
    async function perMeal() {
        var Demos=await selectedDemos();
        var fullData= await getData();
        var newSet=await narrowData(Demos,fullData);
        var stats=getStatsPerMeal(newSet);
        alert("(Per Meal) Avg Calories: "+ stats.calories +" Avg Carbs: "+ stats.carbs +" Avg Fat: "+ stats.fat +" Avg Protein: "+ stats.protein);

    }

</script>
</html>