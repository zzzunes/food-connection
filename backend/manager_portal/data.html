<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta charset="utf-8">
    <title>User Data</title>

</head>
<body>
<h1> User Data Statistics</h1>
    Choose all the criteria of users to be used in calculation of statistics: <br><br>
        <div>
        If no selection is made, result will reflect all users in the database.<br><br><br>

            <div class="checkboxes" >
                Gender:
                <label style="padding-left: 30px">male<input type="checkbox" name="male" id="male"></label>
                <label>female<input type="checkbox" name="female" id="female"></label>
                <label>non-binary<input type="checkbox" name="non_binary" id="non_binary"></label>
                <br><br>
            </div>

            <div class="checkboxes">
                Race:
                <label style="padding-left: 30px">Black<input type="checkbox" name="black" value= "" id="black"></label>
                <label>White<input type="checkbox" name="white" id="white"></label>
                <label>Asian<input type="checkbox" name="asian" id="asian"></label>
                <label>Native American<input type="checkbox" name="native_am" id="native_am"></label>
                <label>Native Hawaiian<input type="checkbox" name="native_haw" id="native_haw"></label>
                <label>Other<input type="checkbox" name="other" id="other"></label>
            </div>
        <br><br>

        Age Range:

            <label style="padding-left: 30px ">min<input type="number" name="min_age" id="min_age" value="18" min="1" max="100"></label>
            <label style="display: inline-block">max<input type="number" name="min_age" id="max_age" value="25" min="1" max="100"></label>
        <br><br>

        Weight:
            <label style="padding-left: 30px ">min<input type="number" name="min_weight" id="min_weight" value="1"  min="1" max="1000"></label>
            <label style="display: inline-block">max<input type="number" name="max_weight" id="max_weight" value="500"  min="1" max="500"></label>
            <br><br>

        Height:
            <label style="padding-left: 30px ">min<input type="number" name="min_height" id="min_height" value="0" min="1" max="100"></label>
            <label style="display: inline-block">max<input type="number" name="min_height" id="max_height" value="100" min="1" max="100"></label>
            <br><br>


            <div class="checkboxes">
                Activity level:
                <label style="padding-left: 30px">Sedentary<input type="checkbox" name="sedentary" id="sedentary"></label>
                <label>Active (Low)<input type="checkbox" name="active_low" id="active_low"></label>
                <label>Active (Medium)<input type="checkbox" name="active_med" id="active_med"></label>
                <label>Active (High)<input type="checkbox" name="active_hi" id="active_hi"></label>
                </div>
        <br><br>



        </div>


        <input type="submit" value="Average Nutrients per Meal" onclick="perMeal()">
        <input type="submit" value="Show Raw Data" onclick="showRaw()" >
    <!-- FOR FUTURE IMPLEMENTATION
    <div>
        Date:
        <label> since: <input type="date" name="date_range_num" id="date_range_num" > </label>

    </div>>

    Major:
    <div>
        <label>Math<input type="checkbox" name="black" id="math"></label>
        <label>Engineering<input type="checkbox" name="black" id="engineering"></label>
        <label>Liberal Arts<input type="checkbox" name="black" id="liberal_arts"></label>
        <label>Health Science<input type="checkbox" name="black" id="health_science"></label>
    </div><br><br>
    FOR FUTURE IMPLEMENTATION-->

</body>
<script type="text/javascript">


    /*Fetch data from DB
    * returns array of User objects
    * */
    async function getData(){
        var jsonData= await fetch('/users/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(res=>res.json())
            .then( json=> {return json;});
        console.log("Data fetched.");
        return jsonData; //Array of users
    }//end getData()


    /*Displays data
    * prints: user data as: gender, age, race, height, weight activity level.
    * */
    function display(data){

        for (let e=0;e<data.length; e++){
            console.log(data[e].gender,data[e].age,data[e].race, data[e].height, data[e].weight, data[e].activityLevel);
        }
    }//end display()


    /*Collects user criterias from HTML input
    * returns: an Array of criterias
    * */
    async function selectedDemos(){
        var demos={};
        const male = document.getElementById("male");
        const female = document.getElementById("female");
        const non_binary = document.getElementById("non_binary");
        const black = document.getElementById("black");
        const white = document.getElementById("white");
        const asian = document.getElementById("asian");
        const natAmerican = document.getElementById("native_am");
        const natHawaiian = document.getElementById("native_haw");
        const min_age = document.getElementById("min_age").value;
        const max_age = document.getElementById("max_age").value;
        const min_weight = document.getElementById("min_weight").value;
        const max_weight = document.getElementById("max_weight").value;
        const min_height = document.getElementById("min_height").value;
        const max_height = document.getElementById("max_height").value;
        const sedentary=document.getElementById("sedentary");
        const act_low=document.getElementById("active_low");
        const act_med=document.getElementById("active_med");
        const act_high=document.getElementById("active_hi");


        var genders=[];
        if (male.checked){
            genders.push("Male");
        }
        if (female.checked){
            genders.push("Female");
        }
        if (non_binary.checked) {
            genders.push("Non-Binary");
        }
        var key="genders";
        demos[key]=genders;

        var races=[];
        if (black.checked){
            races.push("Black");
        }
        if (white.checked){
            races.push("White");
        }
        if (asian.checked){
            races.push("Asian");
        }
        if (natAmerican.checked){
            races.push("Hispanic");
        }
        if (natHawaiian.checked){
            races.push("Hispanic");
        }
        key="races";
        demos[key] = races;

       // var numInputs=[];//Used to check number input compliance.

        var ageRange=[];
        ageRange[0]=min_age;
        if(typeof min_age=="") ageRange[0]=min_age.defaultValue;
        ageRange[1]=max_age;
        if(ageRange[1]=="") ageRange[1]=max_age.defaultValue;
        //console.log(ageRange[0],ageRange[1]);
        key="ageRange";
        demos[key] = ageRange;
        //numInputs.push(ageRange);

        var weightRange=[];
        weightRange[0]=min_weight;
        if(typeof min_weight=="") weightRange[0]=min_age.defaultValue;
        weightRange[1]=max_weight;
        if(weightRange[1]=="") weightRange[1]=max_age.defaultValue;
        //console.log(ageRange[0],ageRange[1]);
        key="weightRange";
        demos[key] = weightRange;
        //numInputs.push(weightRange);
        //console.log(weightRange);

        var heightRange=[];
        heightRange[0]=min_height;
        if(heightRange[0]=="") heightRange[0]=min_height.defaultValue;
        heightRange[1]=max_height;
        if(heightRange[1]=="") heightRange[1]=max_height.defaultValue;
        key="heightRange";
        demos[key] = heightRange;



        var actLevels=[]
        if (sedentary.checked){
            actLevels.push("Sedentary");
        }
        if (act_low.checked){
            actLevels.push("Low");
        }
        if (act_med.checked){
            actLevels.push("Medium");
        }
        if (act_high.checked){
            actLevels.push("High");
        }
        key="activity";
        demos[key] = actLevels;

        return demos;
    }//end selectedDemos()


    /*filters data by demographic criteria
    * Arguments: array of demo criterias, array of users
    * returns: array of users that meet criterias.
    *  */
    function narrowData(demos,arrayData) {
        var filteredData=[];
        for(let e in arrayData) {
            //console.log(demos.genders[0]);
            if (demos.genders[0] != undefined) {
                var gender= arrayData[e].gender;
                if (demos.genders.find(function(element){return element == gender;})== undefined){
                    continue;

                }
            }
            //console.log(demos.races[0]);
            if (demos.races[0] != undefined ) {
                var race= arrayData[e].race;
                if (demos.races.find(function(element){return element == race;}) == undefined){
                    continue;
                }
            }
            if (demos.activity[0] != undefined ) {
                var activityLevel= arrayData[e].activityLevel;
                if (demos.activity.find(function(element){return element == activityLevel;}) == undefined){
                    continue;
                }
            }

            if (demos.ageRange[0] != 0 || demos.ageRange[1] != 100) {
                var age= arrayData[e].age;
                if (age<demos.ageRange[0] || age> demos.ageRange[1]){
                    continue;
                }
            }
            if (demos.weightRange[0] != 0 || demos.weightRange[1] != 100) {
                var age= arrayData[e].weight;
                if (age<demos.weightRange[0] || age> demos.weightRange[1]){
                    continue;
                }
            }
            if (demos.heightRange[0] != 0 || demos.heightRange[1] != 100) {
                var age= arrayData[e].height;
                if (age<demos.heightRange[0] || age> demos.heightRange[1]){
                    continue;
                }
            }
           filteredData.push(arrayData[e]);
        }
        return filteredData;
    }// end narrowData()

    function getStatsPerMeal(userArray,option=0){
        var microNutes=["calories","carbs","fat","protein"];
        var populationMicroNutesPm;
        var userCount=0;

        var userMicroNutesPMeal=[];
        for (let u in userArray){
            var userTotals=[0,0,0,0]; //[calories,carbs,fat,protein]
            let mealCount=0;
            if (typeof userArray[u].foodHistory[0]=="undefined") continue;
            else {
                for (let f in userArray[u].foodHistory) {
                    userTotals[0] += userArray[u].foodHistory[f].food.calories;
                    userTotals[1] += userArray[u].foodHistory[f].food.carbs;
                    userTotals[2] += userArray[u].foodHistory[f].food.fat;
                    userTotals[3] += userArray[u].foodHistory[f].food.protein;
                    mealCount++;
                }
                userMicroNutesPMeal.push({[microNutes[0]]:userTotals[0]/mealCount,[microNutes[1]]:userTotals[1]/mealCount,[microNutes[2]]:userTotals[2]/mealCount,[microNutes[3]]:userTotals[3]/mealCount});
                userCount++;
            }

        }
        var populationTots=[0,0,0,0];  //[calories,carbs,fat,protein]
        for (let e in userMicroNutesPMeal){
            populationTots[0] += userMicroNutesPMeal[e].calories;
            populationTots[1] += userMicroNutesPMeal[e].carbs;
            populationTots[2] += userMicroNutesPMeal[e].fat;
            populationTots[3] += userMicroNutesPMeal[e].protein;
        }
        populationMicroNutesPm={[microNutes[0]]:(populationTots[0]/userCount).toPrecision(3),[microNutes[1]]:(populationTots[1]/userCount).toPrecision(3),[microNutes[2]]:(populationTots[2]/userCount).toPrecision(3),[microNutes[3]]:(populationTots[3]/userCount).toPrecision(3)};
        if (option===0) return populationMicroNutesPm;
        else return userMicroNutesPMeal;
    }


    /* main method that runs onclick()*/
    async function perMeal() {
        var Demos=await selectedDemos();
        var fullData= await getData();
        var newSet=await narrowData(Demos,fullData);
        console.log("ALL USERS (",fullData.length,") users:");
        display(fullData);
        console.log("FILTERED USERS (",newSet.length,") users:");
        display(newSet);
        var stats=getStatsPerMeal(newSet);
        alert("(Per Meal) Avg Calories: "+ stats.calories +" Avg Carbs: "+ stats.carbs +" Avg Fat: "+ stats.fat +" Avg Protein: "+ stats.protein);


    }
    async function showRaw(){
        var Demos=await selectedDemos();
        var fullData= await getData();
        var newSet=await narrowData(Demos,fullData);
        var stats=await getStatsPerMeal(newSet,1);
        var viewable=[]
        for (let e=0;e<newSet.length; e++){
            viewable.push(String(newSet[e].username),String(newSet[e].gender),String(newSet[e].age),String(newSet[e].race), String(newSet[e].height), String(newSet[e].weight), String(newSet[e].activityLevel),"\n");
        }
        alert(viewable);

    }

</script>
<style>
    label, input {
        display: inline-block;
        padding-left: 10px;
        text-wrap: avoid;
    }
    label {
        margin-bottom: 20px;
        color: white;
    }
    body {
        background-color: #2d2d2d;
        color: white;
    }


</style>
</html>